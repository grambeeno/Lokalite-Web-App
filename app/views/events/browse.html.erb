<% 
  if params[:organization]
    context("Events by #{ Organization.find(params[:organization]).name.inspect }")
  else
    browse_context = browse_context_for(params)
    context(
      (
        browse_context.category + ' events ' +
        browse_context.keywords + ' ' +
        browse_context.date + ' in ' +
        browse_context.location
      ).titleize
    )
  end
%>

<!--
  left sidebar

  note HACK since no directory....
-->
  <%= render :partial => 'sidebar' %>



<!--
  main content
-->

<% if session[:splash] === true %>
  <section class="profile blurb vevent" id="welcome">
    <p class="visuallyhidden">Welcome to lokalite, your event directory. Use the categories at left to find what you're in the mood for. Browse below. Up above, sign up to start listing your own events. Share with your friends!</p>

    <img src="/images/landing_page.png" width="680" />

    <nav style="margin:-15px 0 0 270px;">
      <%= link_to 'promo video', static_path(:movie, :layout => :facebox), :rel => :facebox, :class => :button %>
      <%= link_to 'about lokalite', static_path(:about), :class => :button %>

      <%=
        st_url = App.url
        st_title = App.url 
        share_this(:st_url => st_url, :st_title => st_title)
      %>
    </nav>
  </section>
<% 
  session[:splash] = false
  end 
%>

  <% @events.each do |event| 

     event_url = event_path(:id => event.id, :slug => event.slug)
     hours = event.duration / 1.hour
  %>

  <section style="display:none" class="profile blurb vevent" id="event-<%= event.id %>">

    <a href="<%= event.image.url(:medium) %>" rel="facebox"><%= image_tag(event.image.url(:small), :class=>'float-left') %></a>

    <div id="event-data" class="fill-right">
    <hgroup>
      <h1>
        <!-- #<%= event.id %> -->
        <span class="summary">
          <%= link_to(event.name, event_url, :title => "event ##{ event.id }", :style=>"white-space:nowrap;overflow:hidden;") %>
        </span>
      </h1>
      <br />

      <h2>
        <time class="dtstart" datetime="<%= event.starts_at.iso8601 %>">
          <%= event.venue_time_formatted %>
        </time>
        <time class="dtend" datetime="<%= event.ends_at.iso8601 %>">
          <em class='hint'>lasting <%= pluralize(hours, 'hour', 'hours') %></em>
        </time>
      </h2>

      <h3 class="location vcard">
        <span class="fn org"><a class="fn org url" target="blank" href="<%= event.venue.url %>"><%= event.venue.name %></a></span>
        <div class="adr">
          <div class="street-address"><%= event.venue.location.address %></div>
          <span class="locality"><%= event.venue.location.locality %></span>,  
          <abbr class="region"><%= event.venue.location.administrative_area_level_1 %></abbr>
          <span class="postal-code visuallyhidden"><%= event.venue.location.postal_code %></span>
          <span class="country-name visuallyhidden"><%= event.venue.location.country %></span>
          <div class="geo visuallyhidden">
           <span class="latitude"><%= event.venue.location.lat %></span>, 
           <span class="longitude"><%= event.venue.location.lng %></span>
          </div>

        </div>

      </h3>
    </hgroup>

    <div class="description">
      <%= c event.description.ellipsis(256) %>
    </div>

    <nav id="event-buttons">
      <%= link_to("More Event Details", event_path(:id => event.id, :slug => event.slug), :class=>:button) %>
      <%= 
        link_to(
          raw("More by &ldquo;#{ h event.organization.name }&rdquo;"),
          #browse_path(:organization => event.organization.id, :location => false), :class=>'button'
          event.organization.directory_path, :class=>'button'
        )
      %>

      <%=
        st_url = event_path(:id => event.id, :slug => event.slug, :only_path => false)
        st_title = "#{ App.url } [#{ event.name.ellipsis(64) }]"
        share_this(:st_url => st_url, :st_title => st_title)
      %>
    </nav>


  </div>

  </section>
  <% end %>

  <table class="search-results">

    <tr>
      <th><%= link_to('Event', browse_path(:order => :name)) %></th>
      <th><%= link_to('Date', browse_path(:order => :date)) %></th>
      <th><%= link_to('Category', browse_path(:order => :category)) %></th>
      <th><%= link_to('Venue', browse_path(:order => :venue)) %></th>
      <th><%= link_to('Location', browse_path(:order => :location)) %></th>
    </tr>

    <% if @events.empty? %>
      <tr class="huge"><td colspan="5">
      <%= render :partial => 'no_results' %>
      </td></tr>
    <% end %>

    <% @events.each do |event| %>
      <%
        href = event_path(:slug => event.slug, :id => event.id)
      %>
    
      <tr>
        <td>
          <a href="<%= href %>" class="targeting" data-target-class="blurb" data-target="event-<%= event.id %>"><%= event.name %></a>
        </td>
        <td>
          <a href="<%= href %>" class="targeting" data-target-class="blurb" data-target="event-<%= event.id %>"><%= event.venue_time_formatted %></a>
        </td>
        <td>
          <a href="<%= href %>" class="targeting" data-target-class="blurb" data-target="event-<%= event.id %>"><%= event.category.name rescue event.id %></a>
        </td>
        <td>
          <a href="<%= href %>" class="targeting" data-target-class="blurb" data-target="event-<%= event.id %>"><%= event.venue.name %></a>
        </td>
        <td>
          <a href="<%= href %>" class="targeting" data-target-class="blurb" data-target="event-<%= event.id %>"><%= event.venue.location.locality.titleize %></a>
        </td>
      </tr>

    <% end %>

  </table>

  <script type="text/javascript">
    jq(function(){
      jq('a.targeting').each(function(){
        var a = jq(this);
        var tr = a.parents('tr');

        var target_class = a.attr('data-target-class');
        var target = a.attr('data-target');

        var click = function(){
          jq('.' + target_class).hide();
          jq('#' + target).show();
          tr.siblings('tr').removeClass('active');
          tr.addClass('active');
          return(false);
        };

        a.click(click);
      });

      if (! jq('#welcome').length) {
        jq('a.targeting:first').click();
      }
    });
  </script>

  <nav id="pagination">
    <%= paginate @events %>
  </nav>
